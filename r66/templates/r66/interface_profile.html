{% extends "r66/base.html" %}
{% load i18n %}
{% load r66_extras %}
{% load sekizai_tags %}


        {% block sidebar %}
			  <div class="span3">
					<div id="div-sidebar-nav" class="well sidebar-nav" > 
						<ul class="nav nav-list">
						</ul>
					</div><!--/.well -->
        </div><!--/span-->
        {% endblock sidebar %}


          {% block content %}
            {% block object-tools %}
            {% endblock %}
						{{ content }}
    <div id="div-form" class="span6">
		<form action="" method="post" id="profile_form"
			accept-charset="utf-8">{% csrf_token %}
			
      <table class="table table-striped table-bordered table-condensed">
      <thead>
          <tr>
            <th colspan="2">General settings</th>
          </tr>
          <tr>
            <th>Name</th>
            <th>Value</th>
          </tr>
        </thead>

        {{ netiface_profile_form.as_table }}
      </table>

      <table class="table table-striped table-bordered table-condensed">
      <thead>
          <tr>
            <th colspan="2">Network settings</th>
          </tr>
          <tr>
            <th>Name</th>
            <th>Value</th>
          </tr>
        </thead>

        {{ net_settings_form.as_table }}
			</table>

      <table class="table table-striped table-bordered table-condensed">
      <thead>
          <tr>
            <th colspan="2">More Network settings</th>
          </tr>
          <tr>
            <th>Name</th>
            <th>Value</th>
          </tr>
        </thead>

        {{ net_settings_extended_form.as_table }}
      </table>


      <table class="table table-striped table-bordered table-condensed">
      <thead>
          <tr>
            <th colspan="2">Wifi settings</th>
          </tr>
          <tr>
            <th>Name</th>
            <th>Value</th>
          </tr>
        </thead>

        {{ wifi_settings_form.as_table }}
      </table>

      <table class="table table-striped table-bordered table-condensed">
      <thead>
          <tr>
            <th colspan="2">DHCP daemon settings</th>
          </tr>
          <tr>
            <th>Name</th>
            <th>Value</th>
          </tr>
        </thead>

        {{ dhcpd_settings_form.as_table }}
      </table>

      {% if selected_profile %}
        <div style="display:none">
          <input type="hidden" 
            value="{{selected_profile}}" 
            name="selected_profile">
        </div>
      {% endif%}

      {% if selected_profile %}
			    <p>
		      <input value="Update profile" id="send_msg"
					onclick="send_netiface_profile();" type="button" />
					
					<input value="Delete profile" id="send_msg"
					onclick="delete_netiface_profile();" type="button" />

					</p>
      {% else %}
          <p><input value="Create profile" id="send_msg"
          onclick="send_netiface_profile();" type="button" /></p>
      {% endif %}

    </form>
    </div>


{% addtoblock "js" %}
<script type="text/javascript">

  {% if selected_profile %}
    var selected_profile = {{ selected_profile }};
  {% else %}
    var selected_profile = undefined;
  {% endif %}

  function generic_netiface_profile_callback(data){

     // Updating netifaces profiles navside
     // Dajaxice.r66.get_netifaces(get_netifaces_js_callback);

     if (data.status.length > 0)
     {
       error = '<div id="alert-error" class="alert alert-error">'
        + '  <button class="close" data-dismiss="alert">×</button>'
				+ '    <ul>';

				for (message in data.status){
          error = error + "<li>" + data.status[message] + "</li>";
				}

      error = error + '    </ul>'
        + '</div>';
		  $("#alert-error").replaceWith(error);
		 }
		 else 
		 {
		   info = '<div id="alert-info" class="alert alert-info">'
        + '  <button class="close" data-dismiss="alert">×</button>'
        + '    <ul>'
        + '      <li> Correctly updated </li>'
        + '    </ul>'
        + '</div>';

			 $("#alert-info").replaceWith(info);

			 window.location.href = "{% url r66-success %}";

    }

  }

  function delete_netiface_profile(){
    Dajaxice.r66.delete_netiface_profile(generic_netiface_profile_callback,
        {'id':{{ selected_profile }}});
    return false;
  }


  function send_netiface_profile(){
    data = $('#profile_form').serializeArray();
    Dajaxice.r66.send_netiface_profile(generic_netiface_profile_callback, {'form':data});
    return false;
  }

  function get_netiface_profiles_js_callback(data){

		var items = new Array();
		$.each(data, function(key_profile, profile) {
      if ( items[profile["fields"]["netiface"]] == undefined )
			{
			  items[profile["fields"]["netiface"]] = [];
			}
			var active = "";
			if  (selected_profile == profile["pk"] )
			{
			  active = 'class="active"';
			}

      items[profile["fields"]["netiface"]].push(
				'<li ' + active + '>'
  				+ '<a href="{% url r66-interfaces  %}' + profile["pk"] + '">'
					+ profile["pk"] 
					+ '</a>'
					+ '</li>'
      );
    });
		
		for(var key in items){
			var li_items = items[key].join('\n');
		  $("#nav-li-" + key).replaceWith(li_items);
		}

  }


	function get_netifaces_js_callback(data){

    var nav_header_items = [];

		$.each(data, function(key_iface, iface) {
      if ( iface["fields"]["enabled"]) {
      nav_header_items.push(
					'<li id="nav-header-' + iface["pk"] + '" class="nav-header">' 
					+ iface["fields"]["name"] + '</li>' 
					+ ' <li id="nav-li-' + iface["pk"] + '" /> ' 
					+ ' <li><a href="{% url r66-interfaces-new %}"> Add profile </a></li>'

				);
			}

    });

		var ul = $('<ul class="nav nav-list"> ' + nav_header_items.join('\n') + ' </ul>');

		$("#div-sidebar-nav").replaceWith('<div id="div-sidebar-nav" class="well sidebar-nav" >');
    ul.appendTo('#div-sidebar-nav');

    Dajaxice.r66.get_netiface_profiles(get_netiface_profiles_js_callback);

  }


  $( function() {

    Dajaxice.r66.get_netifaces(get_netifaces_js_callback);

  });

</script>
{% endaddtoblock %}




          {% endblock %}


